<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Anonymous Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      background: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    .app-container {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      background: #1e1e1e;
      position: relative;
    }
    .setup-screen {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1e1e1e;
    }
    .setup-card {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }
    .room-code-input {
      background: #222;
      border: 1.5px solid #444;
      color: #ddd;
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 16px;
    }
    .room-code-input:focus {
      background: #222;
      border-color: #666;
      color: #ddd;
      box-shadow: none;
    }
    .btn-join {
      background: #333;
      color: #eee;
      border: none;
      border-radius: 20px;
      padding: 12px;
      font-weight: 600;
      width: 100%;
      transition: background 0.2s;
    }
    .btn-join:hover {
      background: #444;
      color: #eee;
    }
    .chat-container {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .chat-header {
      background: #222;
      border-bottom: 1px solid #333;
      padding: 4px 12px;
      flex-shrink: 0;
    }
    .room-badge {
      background: #1a1a1a;
      color: #bbb;
      border: 1px solid #444;
      padding: 3px 8px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 12px;
    }
    .btn-leave {
      background: #550000;
      color: #f2a1a1;
      border: none;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      transition: background 0.2s;
    }
    .btn-leave:hover {
      background: #770000;
      color: #f2a1a1;
    }
    .user-count {
      color: #888;
      font-size: 11px;
    }
    .messages-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      background: #121212;
      padding: 15px;
      padding-bottom: 30px;
      min-height: 0;
    }
    .message {
      max-width: 75%;
      margin-bottom: 10px;
      padding: 10px 15px;
      border-radius: 16px;
      word-wrap: break-word;
      font-size: 14px;
    }
    .message.own {
      background: #3a2a72;
      color: #eee;
      margin-left: auto;
    }
    .message.other {
      background: #292929;
      color: #ccc;
      border-left: 3px solid #555;
    }
    .message strong {
      display: block;
      margin-bottom: 5px;
      font-size: 13px;
    }
    .timestamp {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 5px;
      font-style: italic;
    }
    .status-msg {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 10px;
      font-size: 13px;
    }
    .image-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 12px;
      margin-top: 8px;
      cursor: pointer;
      border: 1px solid #444;
    }
    .message-footer {
      background: #222;
      border-top: 1px solid #333;
      padding: 6px 12px 8px 12px;
      flex-shrink: 0;
      position: relative;
      z-index: 100;
    }
    .bottom-spacer {
      background: #1a1a1a;
      height: 10px;
      flex-shrink: 0;
      border-top: 1px solid #2a2a2a;
      position: relative;
      z-index: 99;
    }
    @supports (-webkit-touch-callout: none) {
      .chat-container {
        height: -webkit-fill-available;
      }
      .app-container {
        height: -webkit-fill-available;
      }
      .message-footer {
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
      }
      .bottom-spacer {
        height: calc(10px + env(safe-area-inset-bottom));
      }
    }
    @media screen and (max-width: 768px) {
      .message-footer {
        padding-bottom: 10px;
      }
      .bottom-spacer {
        height: 12px;
      }
    }
    .message-input {
      background: #121212;
      border: 1.5px solid #444;
      color: #ddd;
      border-radius: 18px;
      padding: 8px 12px;
      font-size: 14px;
      flex: 1;
      height: 36px;
    }
    .message-input:focus {
      background: #121212;
      border-color: #6666aa;
      color: #ddd;
      box-shadow: none;
    }
    .message-input::placeholder {
      color: #666;
    }
    .btn-attach {
      background: none;
      border: none;
      color: #bbb;
      font-size: 18px;
      padding: 0 8px;
      transition: color 0.2s;
      cursor: pointer;
    }
    .btn-attach:hover {
      color: #ddd;
    }
    .btn-attach:active {
      transform: scale(0.95);
    }
    .btn-attach.recording {
      color: #ff4444;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .btn-send {
      background: #444;
      color: #ddd;
      border: none;
      padding: 8px 12px;
      border-radius: 50%;
      font-size: 16px;
      transition: background 0.2s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-send:hover {
      background: #555;
      color: #ddd;
    }
    .recording-indicator {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 68, 68, 0.9);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .recording-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .media-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .media-modal.active {
      display: flex;
    }
    .media-modal-content {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    .bottom-sheet-modal {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      animation: fadeIn 0.3s ease-out;
    }
    
    .bottom-sheet-modal.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .bottom-sheet-content {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 90vh;
      background: #1a1a1a;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      animation: slideUp 0.3s ease-out;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .bottom-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #333;
      color: #fff;
      flex-shrink: 0;
    }
    
    .bottom-sheet-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .bottom-sheet-close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      font-size: 24px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .bottom-sheet-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .bottom-sheet-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .bottom-sheet-media {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .bottom-sheet-media img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      max-height: 70vh;
      object-fit: contain;
    }
    
    .bottom-sheet-media video {
      width: 100%;
      height: auto;
      border-radius: 12px;
      max-height: 70vh;
      outline: none;
    }
    
    .bottom-sheet-media audio {
      width: 100%;
      outline: none;
    }
    
    .bottom-sheet-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 20px;
      border-top: 1px solid #333;
      flex-shrink: 0;
    }
    
    .bottom-sheet-action-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      padding: 12px 24px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    
    .bottom-sheet-action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    .media-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      font-size: 30px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .media-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .media-download-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      font-size: 24px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      text-decoration: none;
    }
    .media-download-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      color: #fff;
    }
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #03dac6;
      color: #121212;
      padding: 12px 20px;
      border-radius: 20px;
      font-weight: 600;
      z-index: 9998;
      display: none;
    }
    .toast-notification.error {
      background: #bb5555;
      color: #eee;
    }
    .messages-container::-webkit-scrollbar {
      width: 6px;
    }
    .messages-container::-webkit-scrollbar-track {
      background: #121212;
    }
    .messages-container::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="setup-screen" id="setupScreen">
      <div class="setup-card">
        <div class="mb-3">
          <label class="form-label text-secondary">Room Code</label>
          <input type="text" id="roomCode" class="form-control room-code-input" placeholder="Enter room code" autocomplete="off">
        </div>
        <button class="btn btn-join" onclick="joinRoom()">Join Room</button>
      </div>
    </div>

    <div class="chat-container d-none" id="chatScreen">
      <div class="chat-header d-flex justify-content-between align-items-center">
        <span class="room-badge" id="currentRoom"></span>
        <div class="d-flex align-items-center gap-2">
          <span class="user-count" id="userCount">👥 0 online</span>
          <button class="btn btn-leave btn-sm" onclick="leaveRoom()">← Leave</button>
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="status-msg">Loading messages...</div>
      </div>

      <div class="message-footer">
        <div class="d-flex align-items-center gap-2">
          <input type="file" id="fileInput" class="d-none" accept="*/*">
          <button class="btn-attach" onclick="document.getElementById('fileInput').click()">📎</button>
          <button class="btn-attach" id="audioBtn">🎤</button>
          <input type="text" id="messageInput" class="form-control message-input" placeholder="Type message..." maxlength="500" autocomplete="off">
          <button class="btn btn-send" onclick="sendMessage()">➤</button>
        </div>
        <div id="recordingIndicator" class="recording-indicator d-none">
          <span class="recording-dot"></span> Recording...
        </div>
      </div>

      <div class="bottom-spacer"></div>
    </div>
  </div>

  <div class="bottom-sheet-modal" id="mediaBottomSheet" onclick="if(event.target === this) closeBottomSheet()">
    <div class="bottom-sheet-content">
      <div class="bottom-sheet-header">
        <div class="bottom-sheet-title" id="bottomSheetTitle">Media</div>
        <button class="bottom-sheet-close-btn" onclick="closeBottomSheet()">×</button>
      </div>
      <div class="bottom-sheet-body">
        <div class="bottom-sheet-media" id="bottomSheetMedia"></div>
      </div>
      <div class="bottom-sheet-actions" id="bottomSheetActions"></div>
    </div>
  </div>

  <div class="toast-notification" id="toastNotification"></div>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyBhpJ1yAo92xLx6L3GyTVTuZsOXYYDZKWs",
      authDomain: "anon-ac806.firebaseapp.com",
      databaseURL: "https://anon-ac806-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "anon-ac806",
      storageBucket: "anon-ac806.appspot.com",
      messagingSenderId: "692292101984",
      appId: "1:692292101984:web:15ad6efcd0bc1411982005",
      measurementId: "G-1888WQV1PV"
    };
    var app = firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    let currentRoom = '';
    let userId = 'anon_' + Math.random().toString(36).substr(2, 12);
    let messagesRef = null;
    let usersRef = null;
    let userPresenceRef = null;
    let heartbeatInterval = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    document.addEventListener('DOMContentLoaded', function() {
      localStorage.removeItem('chatRoom');
      
      document.getElementById('roomCode').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') joinRoom();
      });
      
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') sendMessage();
      });

      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      
      const audioBtn = document.getElementById('audioBtn');
      audioBtn.addEventListener('mousedown', startRecording);
      audioBtn.addEventListener('mouseup', stopRecording);
      audioBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startRecording();
      });
      audioBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopRecording();
      });
      audioBtn.addEventListener('mouseleave', () => {
        if (isRecording) stopRecording();
      });
    });

    function joinRoom() {
      const code = document.getElementById('roomCode').value.trim();
      if (!code) {
        showNotification('Please enter a room code', 'error');
        return;
      }
      
      currentRoom = code;
      document.getElementById('currentRoom').textContent = currentRoom;
      messagesRef = database.ref('rooms/' + currentRoom + '/messages');
      usersRef = database.ref('rooms/' + currentRoom + '/users');
      
      userPresenceRef = usersRef.child(userId);
      userPresenceRef.set({
        name: userId.substr(5, 4),
        lastSeen: firebase.database.ServerValue.TIMESTAMP,
        online: true
      });
      
      userPresenceRef.onDisconnect().update({
        online: false,
        lastSeen: firebase.database.ServerValue.TIMESTAMP
      });
      
      startHeartbeat();
      
      document.getElementById('setupScreen').classList.add('d-none');
      document.getElementById('chatScreen').classList.remove('d-none');
      
      listenForMessages();
      listenForUsers();
      showNotification('Joined room');
      setTimeout(scrollToBottom, 100);
    }

    function listenForMessages() {
      if (!messagesRef) return;
      messagesRef.off();
      const container = document.getElementById('messagesContainer');
      container.innerHTML = '';
      messagesRef.on('child_added', snapshot => {
        displayMessage(snapshot.val());
      });
    }

    function listenForUsers() {
      if (!usersRef) return;
      
      usersRef.on('value', snapshot => {
        const users = snapshot.val();
        let onlineCount = 0;
        
        if (users) {
          const now = Date.now();
          Object.keys(users).forEach(userIdKey => {
            const user = users[userIdKey];
            if (user.online) {
              onlineCount++;
            } else if (user.lastSeen && (now - user.lastSeen > 30000)) {
              usersRef.child(userIdKey).remove();
            }
          });
        }
        
        document.getElementById('userCount').textContent = `👥 ${onlineCount} online`;
      });
    }

    function startHeartbeat() {
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      
      heartbeatInterval = setInterval(() => {
        if (userPresenceRef) {
          userPresenceRef.update({
            lastSeen: firebase.database.ServerValue.TIMESTAMP,
            online: true
          });
        }
      }, 10000);
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !messagesRef) return;
      
      const message = {
        id: Date.now() + '_' + Math.random(),
        text: text,
        sender: userId,
        senderName: userId.substr(5, 4),
        timestamp: Date.now(),
        type: 'text'
      };
      
      messagesRef.push(message).then(() => {
        input.value = '';
        setTimeout(scrollToBottom, 50);
      }).catch(() => showNotification('Error sending message', 'error'));
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const maxSize = 50 * 1024 * 1024;
      if (file.size > maxSize) {
        showNotification('File too large (max 50MB)', 'error');
        e.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        const message = {
          id: Date.now() + '_' + Math.random(),
          text: file.name,
          fileData: evt.target.result,
          fileType: file.type,
          sender: userId,
          senderName: userId.substr(5, 4),
          timestamp: Date.now(),
          type: 'file',
        };
        
        messagesRef.push(message).then(() => {
          showNotification('File sent');
          e.target.value = '';
          setTimeout(scrollToBottom, 50);
        }).catch(() => {
          showNotification('Error sending file', 'error');
          e.target.value = '';
        });
      }
      reader.readAsDataURL(file);
    }

    async function startRecording() {
      if (isRecording) return;
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          
          reader.onload = function(evt) {
            const audioId = 'audio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const message = {
              id: Date.now() + '_' + Math.random(),
              text: 'Voice Message',
              fileData: evt.target.result,
              fileType: 'audio/webm',
              sender: userId,
              senderName: userId.substr(5, 4),
              timestamp: Date.now(),
              type: 'audio',
              audioId: audioId
            };
            
            messagesRef.push(message).then(() => {
              showNotification('Voice message sent');
              setTimeout(scrollToBottom, 50);
            }).catch(() => {
              showNotification('Error sending voice message', 'error');
            });
          };
          
          reader.readAsDataURL(audioBlob);
          
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        const audioBtn = document.getElementById('audioBtn');
        audioBtn.textContent = '⏹️';
        audioBtn.classList.add('recording');
        document.getElementById('recordingIndicator').classList.remove('d-none');
      } catch (err) {
        showNotification('Microphone access denied', 'error');
      }
    }

    function stopRecording() {
      if (!isRecording || !mediaRecorder) return;
      
      mediaRecorder.stop();
      isRecording = false;
      const audioBtn = document.getElementById('audioBtn');
      audioBtn.textContent = '🎤';
      audioBtn.classList.remove('recording');
      document.getElementById('recordingIndicator').classList.add('d-none');
    }

    function displayMessage(msg) {
      const container = document.getElementById('messagesContainer');
      
      if (msg.type === 'system') {
        if (msg.text.includes('joined')) {
          const username = msg.text.replace(' joined', '');
          showNotification(`${username} joined the room`);
        }
        return;
      }
      
      const div = document.createElement('div');
      div.className = 'message ' + (msg.sender === userId ? 'own' : 'other');
      
      const msgDate = new Date(msg.timestamp);
      const date = String(msgDate.getDate()).padStart(2, '0') + '/' + String(msgDate.getMonth() + 1).padStart(2, '0');
      const time = msgDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const dateTime = date + ' ' + time;
      
      let html = `<strong>${msg.sender === userId ? 'You' : msg.senderName}</strong>`;
      
      if (msg.type === 'file') {
        const isImage = msg.fileType && (
          msg.fileType.startsWith('image/') ||
          /\.(jpg|jpeg|png|gif|bmp|webp|svg|ico|tiff|tif|heic|heif|avif|jfif)$/i.test(msg.text)
        );
        const isVideo = msg.fileType && (
          msg.fileType.startsWith('video/') ||
          /\.(mp4|webm|ogg|ogv|mov|avi|wmv|flv|mkv|m4v|3gp|mpeg|mpg|m2v|mts|m2ts|vob|ts)$/i.test(msg.text)
        );
        const isAudio = msg.fileType && (
          msg.fileType.startsWith('audio/') ||
          /\.(mp3|wav|ogg|oga|m4a|aac|flac|opus|weba|aiff|ape|wv|tta|tak)$/i.test(msg.text)
        );
        
        if (isImage) {
          html += `<img src="${msg.fileData}" alt="Image" class="image-preview" onclick="openMediaModal('${msg.fileData}', 'image', '${msg.text}')"/>`;
        } else if (isVideo) {
          html += `<video class="image-preview" onclick="openMediaModal('${msg.fileData}', 'video', '${msg.text}')"><source src="${msg.fileData}" type="${msg.fileType || 'video/mp4'}"></video>`;
        } else if (isAudio) {
          html += `<audio controls style="max-width: 200px; margin-top: 8px;"><source src="${msg.fileData}" type="${msg.fileType || 'audio/mpeg'}"></audio>`;
        } else {
          html += `<div>📎 <a href="${msg.fileData}" download="${msg.text}" style="color:#6fa8dc;">${msg.text}</a></div>`;
        }
      } else if (msg.type === 'audio') {
        const audioId = msg.audioId || 'audio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        html += `<div style="margin-top: 5px; cursor: pointer; font-size: 24px;" onclick="openMediaModal('${msg.fileData}', 'audio', '${msg.text}', '${audioId}')">🎤</div>`;
        html += `<audio id="${audioId}" style="display: none;" preload="auto"><source src="${msg.fileData}" type="${msg.fileType}"></audio>`;
      } else {
        const linkifiedText = linkifyText(msg.text);
        html += `<div>${linkifiedText}</div>`;
      }
      
      html += `<div class="timestamp">${dateTime}</div>`;
      div.innerHTML = html;
      container.appendChild(div);
      scrollToBottom();
    }

    function linkifyText(text) {
      const urlRegex = /(https?:\/\/[^\s]+|www\.[a-zA-Z0-9-]+\.[a-zA-Z]{2,}(?:[^\s]*)?|(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi;
      
      return text.replace(urlRegex, function(url) {
        if (/\.{2,}/.test(url) || url === '.' || /^\.+$/.test(url)) {
          return url;
        }
        
        const domainPattern = /^(?:www\.)?[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*\.[a-zA-Z]{2,}(?:\/.*)?$/;
        if (!url.match(/^https?:\/\//i) && !domainPattern.test(url)) {
          return url;
        }
        
        let href = url;
        let displayUrl = url;
        
        if (!url.match(/^https?:\/\//i)) {
          if (url.match(/^www\./i)) {
            href = 'https://' + url;
          } else if (url.match(/\.[a-zA-Z]{2,}/)) {
            href = 'https://' + url;
          } else {
            return url;
          }
        }
        
        if (displayUrl.length > 50) {
          displayUrl = displayUrl.substring(0, 47) + '...';
        }
        
        return `<a href="${href}" target="_blank" rel="noopener noreferrer" style="color: #6fa8dc; text-decoration: underline;">${displayUrl}</a>`;
      });
    }

    function openMediaModal(src, type, name, audioId) {
      const modal = document.getElementById('mediaBottomSheet');
      const title = document.getElementById('bottomSheetTitle');
      const mediaContainer = document.getElementById('bottomSheetMedia');
      const actionsContainer = document.getElementById('bottomSheetActions');
      
      mediaContainer.innerHTML = '';
      actionsContainer.innerHTML = '';
      
      if (type === 'image') {
        title.innerHTML = '🖼️ Image';
        const img = document.createElement('img');
        img.src = src;
        img.alt = name || 'Image';
        mediaContainer.appendChild(img);
        
        actionsContainer.innerHTML = `
          <a href="${src}" download="${name || 'image'}" class="bottom-sheet-action-btn">
            ⬇ Download
          </a>
        `;
      } else if (type === 'video') {
        title.innerHTML = '🎥 Video';
        const video = document.createElement('video');
        video.src = src;
        video.controls = true;
        video.setAttribute('controlsList', 'nodownload');
        
        const extension = name ? name.split('.').pop().toLowerCase() : '';
        const mimeTypes = {
          'mp4': 'video/mp4',
          'webm': 'video/webm',
          'ogg': 'video/ogg',
          'ogv': 'video/ogg',
          'mov': 'video/quicktime',
          'avi': 'video/x-msvideo',
          'wmv': 'video/x-ms-wmv',
          'flv': 'video/x-flv',
          'mkv': 'video/x-matroska',
          'm4v': 'video/x-m4v',
          '3gp': 'video/3gpp',
          'mpeg': 'video/mpeg',
          'mpg': 'video/mpeg',
          'm2v': 'video/mpeg',
          'ts': 'video/mp2t'
        };
        
        if (extension && mimeTypes[extension]) {
          const source = document.createElement('source');
          source.src = src;
          source.type = mimeTypes[extension];
          video.appendChild(source);
        }
        
        mediaContainer.appendChild(video);
        
        actionsContainer.innerHTML = `
          <a href="${src}" download="${name || 'video'}" class="bottom-sheet-action-btn">
            ⬇ Download
          </a>
        `;
      } else if (type === 'audio') {
        title.innerHTML = '🎤 Voice Message';
        const audio = document.createElement('audio');
        audio.src = src;
        audio.controls = true;
        
        const extension = name ? name.split('.').pop().toLowerCase() : '';
        const mimeTypes = {
          'mp3': 'audio/mpeg',
          'wav': 'audio/wav',
          'ogg': 'audio/ogg',
          'oga': 'audio/ogg',
          'm4a': 'audio/mp4',
          'aac': 'audio/aac',
          'flac': 'audio/flac',
          'opus': 'audio/opus',
          'webm': 'audio/webm',
          'weba': 'audio/webm',
          'aiff': 'audio/aiff',
          'aif': 'audio/aiff'
        };
        
        if (extension && mimeTypes[extension]) {
          const source = document.createElement('source');
          source.src = src;
          source.type = mimeTypes[extension];
          audio.appendChild(source);
        }
        
        mediaContainer.appendChild(audio);
        
        actionsContainer.innerHTML = `
          <a href="${src}" download="${name || 'voice-message.webm'}" class="bottom-sheet-action-btn">
            ⬇ Download
          </a>
        `;
      }
      
      modal.classList.add('active');
    }
    
    function closeBottomSheet() {
      const modal = document.getElementById('mediaBottomSheet');
      const mediaContainer = document.getElementById('bottomSheetMedia');
      
      const video = mediaContainer.querySelector('video');
      const audio = mediaContainer.querySelector('audio');
      if (video) video.pause();
      if (audio) audio.pause();
      
      modal.classList.remove('active');
      mediaContainer.innerHTML = '';
    }

    function closeMediaModal() {
      closeBottomSheet();
    }

    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      requestAnimationFrame(() => {
        container.scrollTop = container.scrollHeight;
      });
    }

    function leaveRoom() {
      if (messagesRef) {
        messagesRef.off();
      }
      
      if (userPresenceRef) {
        userPresenceRef.update({
          online: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
        userPresenceRef = null;
      }
      
      if (usersRef) {
        usersRef.off();
        usersRef = null;
      }
      
      stopHeartbeat();
      currentRoom = '';
      messagesRef = null;
      
      document.getElementById('chatScreen').classList.add('d-none');
      document.getElementById('setupScreen').classList.remove('d-none');
      document.getElementById('messagesContainer').innerHTML = '<div class="status-msg">Loading messages...</div>';
      document.getElementById('roomCode').value = '';
      document.getElementById('userCount').textContent = '👥 0 online';
      showNotification('Left room');
    }

    function showNotification(text, type='success') {
      const noti = document.getElementById('toastNotification');
      noti.textContent = text;
      noti.className = 'toast-notification' + (type === 'error' ? ' error' : '');
      noti.style.display = 'block';
      clearTimeout(noti._timeout);
      noti._timeout = setTimeout(() => noti.style.display = 'none', 3000);
    }

    window.addEventListener('beforeunload', () => {
      if (messagesRef && currentRoom && userPresenceRef) {
        userPresenceRef.update({
          online: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
        stopHeartbeat();
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (userPresenceRef) {
        if (document.hidden) {
          stopHeartbeat();
          heartbeatInterval = setInterval(() => {
            if (userPresenceRef) {
              userPresenceRef.update({
                lastSeen: firebase.database.ServerValue.TIMESTAMP,
                online: true
              });
            }
          }, 30000);
        } else {
          startHeartbeat();
        }
      }
    });

    window.addEventListener('focus', () => {
      if (userPresenceRef) {
        userPresenceRef.update({
          lastSeen: firebase.database.ServerValue.TIMESTAMP,
          online: true
        });
        startHeartbeat();
      }
    });

    window.addEventListener('blur', () => {
      if (userPresenceRef) {
        stopHeartbeat();
        heartbeatInterval = setInterval(() => {
          if (userPresenceRef) {
            userPresenceRef.update({
              lastSeen: firebase.database.ServerValue.TIMESTAMP,
              online: true
            });
          }
        }, 25000);
      }
    });
  </script>
</body>
</html>
